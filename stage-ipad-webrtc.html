<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>ë¬´ëŒ€ìš© ì¹ íŒ (ì•„ì´íŒ¨ë“œ) - WebRTC</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            touch-action: none;
            background: #000;
        }
        
        /* ëŒ€ê¸° í™”ë©´: ì½”ë“œ ì…ë ¥ */
        #waitingScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s ease;
        }
        
        #waitingScreen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .waiting-container {
            text-align: center;
            padding: 40px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            max-width: 500px;
        }
        
        .waiting-title {
            color: white;
            font-size: 32px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .waiting-subtitle {
            color: rgba(255,255,255,0.7);
            font-size: 18px;
            margin-bottom: 40px;
        }
        
        .code-input-container {
            margin-bottom: 30px;
        }
        
        .code-input {
            width: 100%;
            max-width: 350px;
            padding: 20px;
            font-size: 36px;
            text-align: center;
            letter-spacing: 12px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 15px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            outline: none;
            transition: all 0.3s ease;
        }
        
        .code-input:focus {
            border-color: #667eea;
            background: rgba(102,126,234,0.2);
        }
        
        .connect-btn {
            padding: 18px 60px;
            font-size: 20px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 20px rgba(102,126,234,0.4);
        }
        
        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102,126,234,0.6);
        }
        
        .connect-btn:active {
            transform: translateY(0);
        }
        
        .connect-btn:disabled {
            background: #666;
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #666;
            margin: 20px auto 15px;
            transition: all 0.3s ease;
        }
        
        .status-indicator.connecting {
            background: #ffa500;
            box-shadow: 0 0 20px #ffa500;
            animation: pulse 1.5s infinite;
        }
        
        .status-indicator.connected {
            background: #00ff00;
            box-shadow: 0 0 20px #00ff00;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.error {
            background: #ff4444;
            box-shadow: 0 0 20px #ff4444;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.2); }
        }
        
        .status-text {
            color: rgba(255,255,255,0.8);
            font-size: 16px;
            margin-top: 10px;
        }
        
        .network-info {
            margin-top: 30px;
            padding: 20px;
            background: rgba(33,150,243,0.1);
            border-radius: 12px;
            border-left: 4px solid #2196f3;
        }
        
        .network-info-title {
            color: #64b5f6;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .network-info-text {
            color: rgba(255,255,255,0.6);
            font-size: 13px;
            line-height: 1.6;
        }
        
        /* ê³µê°œ í™”ë©´: ì†ê¸€ì”¨ í‘œì‹œ */
        #revealScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a3a1a;
            background-image:
                radial-gradient(ellipse at 20% 30%, rgba(60,100,60,0.3) 0%, transparent 40%),
                radial-gradient(ellipse at 80% 70%, rgba(20,40,20,0.4) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(255,255,255,0.015) 0%, transparent 100%),
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 3px,
                    rgba(255,255,255,0.008) 3px,
                    rgba(255,255,255,0.008) 4px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 3px,
                    rgba(255,255,255,0.005) 3px,
                    rgba(255,255,255,0.005) 4px
                );
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
            box-shadow: 
                inset 0 0 150px rgba(0,0,0,0.4),
                inset 20px 0 80px rgba(0,0,0,0.3),
                inset -20px 0 80px rgba(0,0,0,0.3),
                inset 0 20px 80px rgba(0,0,0,0.3),
                inset 0 -20px 80px rgba(0,0,0,0.3);
        }
        
        #revealScreen.visible {
            opacity: 1;
            pointer-events: auto;
        }
        
        #handwritingDisplay {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.5s ease;
        }
        
        #handwritingDisplay.show {
            opacity: 1;
            transform: scale(1);
        }
        
        /* ìˆ¨ê²¨ì§„ íŠ¸ë¦¬ê±° ë²„íŠ¼ (í™”ë©´ 4ê°œ ì½”ë„ˆ ë”ë¸”íƒ­ìœ¼ë¡œ ëŒ€ê¸° í™”ë©´ ë³µê·€) */
        .trigger-zone {
            position: absolute;
            width: 100px;
            height: 100px;
            z-index: 200;
        }
        
        .trigger-zone.top-left { top: 0; left: 0; }
        .trigger-zone.top-right { top: 0; right: 0; }
        .trigger-zone.bottom-left { bottom: 0; left: 0; }
        .trigger-zone.bottom-right { bottom: 0; right: 0; }
        
        /* ì—°ê²° ìƒíƒœ ë¯¸ë‹ˆ ì¸ë””ì¼€ì´í„° (ê³µê°œ í™”ë©´ì—ì„œ ë³´ì„) */
        .mini-status {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #00ff00;
            box-shadow: 0 0 15px #00ff00;
            z-index: 150;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .mini-status.visible {
            opacity: 0.7;
        }
        
        .mini-status.disconnected {
            background: #ff4444;
            box-shadow: 0 0 15px #ff4444;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 0.7; }
            50% { opacity: 0.2; }
        }
    </style>
</head>
<body>
    <!-- ëŒ€ê¸° í™”ë©´ -->
    <div id="waitingScreen">
        <div class="waiting-container">
            <div class="waiting-title">ğŸª ë¬´ëŒ€ìš© ì¹ íŒ</div>
            <div class="waiting-subtitle">ì¡°ìˆ˜ ì•±ì— í‘œì‹œëœ 6ìë¦¬ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”</div>
            
            <div class="code-input-container">
                <input 
                    type="text" 
                    id="codeInput" 
                    class="code-input" 
                    placeholder="------" 
                    maxlength="6"
                    autocomplete="off"
                    autocapitalize="characters"
                >
            </div>
            
            <button id="connectBtn" class="connect-btn" onclick="connectToPeer()">
                ğŸ”— ì—°ê²°í•˜ê¸°
            </button>
            
            <div class="status-indicator" id="statusIndicator"></div>
            <div class="status-text" id="statusText">ì½”ë“œë¥¼ ì…ë ¥í•˜ê³  ì—°ê²° ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</div>
            
            <div class="network-info">
                <div class="network-info-title">ğŸ“¡ ë„¤íŠ¸ì›Œí¬ ì„¤ì • í™•ì¸</div>
                <div class="network-info-text">
                    â€¢ ì¡°ìˆ˜ ìŠ¤ë§ˆíŠ¸í°ê³¼ <strong>ê°™ì€ Wi-Fi</strong>ì— ì—°ê²°í•˜ì„¸ìš”<br>
                    â€¢ ë˜ëŠ” ì¡°ìˆ˜ ìŠ¤ë§ˆíŠ¸í°ì˜ <strong>í•«ìŠ¤íŒŸ</strong>ì— ì—°ê²°í•˜ì„¸ìš”<br>
                    â€¢ ì—°ê²° í›„ ì†ê¸€ì”¨ê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì „ì†¡ë©ë‹ˆë‹¤
                </div>
            </div>
        </div>
    </div>
    
    <!-- ê³µê°œ í™”ë©´ -->
    <div id="revealScreen">
        <img id="handwritingDisplay" alt="ì˜ˆì–¸ ì†ê¸€ì”¨">
    </div>
    
    <!-- ë¯¸ë‹ˆ ì—°ê²° ìƒíƒœ í‘œì‹œ -->
    <div class="mini-status" id="miniStatus"></div>
    
    <!-- ìˆ¨ê²¨ì§„ íŠ¸ë¦¬ê±° ì˜ì—­ (ë”ë¸”íƒ­ìœ¼ë¡œ ëŒ€ê¸° í™”ë©´ ë³µê·€) -->
    <div class="trigger-zone top-left" data-corner="1"></div>
    <div class="trigger-zone top-right" data-corner="2"></div>
    <div class="trigger-zone bottom-left" data-corner="3"></div>
    <div class="trigger-zone bottom-right" data-corner="4"></div>

    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        let peer = null;
        let connection = null;
        let isConnected = false;
        let lastReceivedImage = null;
        
        const codeInput = document.getElementById('codeInput');
        const connectBtn = document.getElementById('connectBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const waitingScreen = document.getElementById('waitingScreen');
        const revealScreen = document.getElementById('revealScreen');
        const handwritingDisplay = document.getElementById('handwritingDisplay');
        const miniStatus = document.getElementById('miniStatus');
        
        // ì €ì¥ëœ ì½”ë“œ ë¶ˆëŸ¬ì˜¤ê¸° (ìë™ ì¬ì—°ê²°ìš©)
        const savedCode = localStorage.getItem('lastConnectionCode');
        if (savedCode) {
            codeInput.value = savedCode;
            statusText.textContent = 'ì´ì „ ì—°ê²° ì½”ë“œê°€ ì…ë ¥ë˜ì–´ ìˆìŠµë‹ˆë‹¤';
        }
        
        // ì½”ë“œ ì…ë ¥ ìë™ í¬ì»¤ìŠ¤
        codeInput.focus();
        
        // ì½”ë“œ ì…ë ¥ ì‹œ ìë™ ëŒ€ë¬¸ì ë³€í™˜
        codeInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.toUpperCase();
            if (e.target.value.length === 6) {
                connectBtn.disabled = false;
            }
        });
        
        // Enter í‚¤ë¡œ ì—°ê²°
        codeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && codeInput.value.length === 6) {
                connectToPeer();
            }
        });
        
        // PeerJS ì´ˆê¸°í™” ë° ì—°ê²°
        window.connectToPeer = function() {
            const code = codeInput.value.trim().toUpperCase();
            
            if (code.length !== 6) {
                updateStatus('error', 'ì½”ë“œëŠ” 6ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤');
                return;
            }
            
            // ì½”ë“œ ì €ì¥ (ìë™ ì¬ì—°ê²°ìš©)
            localStorage.setItem('lastConnectionCode', code);
            
            connectBtn.disabled = true;
            updateStatus('connecting', 'ì—°ê²° ì¤‘...');
            
            try {
                // ê¸°ì¡´ ì—°ê²° ì •ë¦¬
                if (peer) {
                    peer.destroy();
                }
                
                // ìƒˆ Peer ìƒì„±
                const myId = 'STAGE-' + Math.random().toString(36).substr(2, 9);
                peer = new Peer(myId, {
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' }
                        ]
                    }
                });
                
                peer.on('open', () => {
                    console.log('Peer ì¤€ë¹„ ì™„ë£Œ:', myId);
                    updateStatus('connecting', 'ì¡°ìˆ˜ ì•±ì— ì—°ê²° ì¤‘...');
                    
                    // Senderì— ì—°ê²° ì‹œë„
                    const targetId = 'SENDER-' + code;
                    connection = peer.connect(targetId);
                    
                    connection.on('open', () => {
                        isConnected = true;
                        updateStatus('connected', 'ì—°ê²° ì„±ê³µ! ì†ê¸€ì”¨ ëŒ€ê¸° ì¤‘...');
                        miniStatus.classList.add('visible');
                        console.log('ì¡°ìˆ˜ ì•±ê³¼ ì—°ê²°ë¨');
                    });
                    
                    connection.on('data', (data) => {
                        console.log('ë°ì´í„° ìˆ˜ì‹ :', data);
                        
                        if (data.type === 'handwriting' && data.image) {
                            lastReceivedImage = data.image;
                            displayHandwriting(data.image);
                        }
                    });
                    
                    connection.on('close', () => {
                        isConnected = false;
                        miniStatus.classList.remove('visible');
                        miniStatus.classList.add('disconnected');
                        updateStatus('error', 'ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì—°ê²°í•˜ì„¸ìš”.');
                        connectBtn.disabled = false;
                        console.log('ì—°ê²° ëŠê¹€');
                    });
                    
                    connection.on('error', (err) => {
                        console.error('ì—°ê²° ì˜¤ë¥˜:', err);
                        updateStatus('error', 'ì—°ê²° ì˜¤ë¥˜: ' + err.message);
                        connectBtn.disabled = false;
                    });
                });
                
                peer.on('error', (err) => {
                    console.error('Peer ì˜¤ë¥˜:', err);
                    let errorMsg = 'ì˜¤ë¥˜ ë°œìƒ';
                    
                    if (err.type === 'peer-unavailable') {
                        errorMsg = 'ì¡°ìˆ˜ ì•±ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì½”ë“œë¥¼ í™•ì¸í•˜ì„¸ìš”.';
                    } else if (err.type === 'network') {
                        errorMsg = 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”';
                    } else {
                        errorMsg = err.message;
                    }
                    
                    updateStatus('error', errorMsg);
                    connectBtn.disabled = false;
                });
                
            } catch (error) {
                console.error('ì—°ê²° ì‹œì‘ ì˜¤ë¥˜:', error);
                updateStatus('error', 'ì—°ê²° ì‹œì‘ ì‹¤íŒ¨: ' + error.message);
                connectBtn.disabled = false;
            }
        };
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStatus(status, message) {
            statusIndicator.className = 'status-indicator ' + status;
            statusText.textContent = message;
        }
        
        // ì†ê¸€ì”¨ í‘œì‹œ
        function displayHandwriting(imageData) {
            // ì´ë¯¸ì§€ë¥¼ 1.2ë°° í¬ê¸°ë¡œ ë¦¬ì‚¬ì´ì¦ˆ
            const tempImg = new Image();
            tempImg.onload = () => {
                // ì„ì‹œ ìº”ë²„ìŠ¤ ìƒì„±
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                // ì›ë³¸ í¬ê¸°ì˜ 1.2ë°°ë¡œ ì„¤ì •
                tempCanvas.width = tempImg.width * 1.2;
                tempCanvas.height = tempImg.height * 1.2;
                
                // 1.2ë°° í™•ëŒ€í•´ì„œ ê·¸ë¦¬ê¸°
                tempCtx.drawImage(tempImg, 0, 0, tempCanvas.width, tempCanvas.height);
                
                // í™•ëŒ€ëœ ì´ë¯¸ì§€ë¥¼ í‘œì‹œ
                handwritingDisplay.src = tempCanvas.toDataURL('image/png');
                
                // ëŒ€ê¸° í™”ë©´ ìˆ¨ê¸°ê³  ê³µê°œ í™”ë©´ í‘œì‹œ
                waitingScreen.classList.add('hidden');
                revealScreen.classList.add('visible');
                
                // ì´ë¯¸ì§€ í˜ì´ë“œì¸ íš¨ê³¼
                setTimeout(() => {
                    handwritingDisplay.classList.add('show');
                }, 100);
                
                console.log('ì†ê¸€ì”¨ í‘œì‹œ ì™„ë£Œ (1.2ë°° í™•ëŒ€)');
            };
            tempImg.src = imageData;
        }
        
        // ëŒ€ê¸° í™”ë©´ìœ¼ë¡œ ë³µê·€ (ë”ë¸”íƒ­)
        let lastTapTime = 0;
        let tapCount = 0;
        
        document.querySelectorAll('.trigger-zone').forEach(zone => {
            const handleTap = (e) => {
                e.preventDefault();
                const now = Date.now();
                
                if (now - lastTapTime < 300) {
                    tapCount++;
                    if (tapCount >= 2) {
                        returnToWaiting();
                    }
                } else {
                    tapCount = 1;
                }
                
                lastTapTime = now;
            };
            
            zone.addEventListener('touchstart', handleTap);
            zone.addEventListener('click', handleTap);
        });
        
        // ëŒ€ê¸° í™”ë©´ìœ¼ë¡œ ë³µê·€
        function returnToWaiting() {
            revealScreen.classList.remove('visible');
            handwritingDisplay.classList.remove('show');
            waitingScreen.classList.remove('hidden');
            miniStatus.classList.remove('visible');
            
            console.log('ëŒ€ê¸° í™”ë©´ìœ¼ë¡œ ë³µê·€');
        }
        
        // í™”ë©´ êº¼ì§ ë°©ì§€
        let wakeLock = null;
        if ('wakeLock' in navigator) {
            navigator.wakeLock.request('screen').then(lock => {
                wakeLock = lock;
                console.log('í™”ë©´ êº¼ì§ ë°©ì§€ í™œì„±í™”');
            }).catch(err => {
                console.log('í™”ë©´ êº¼ì§ ë°©ì§€ ì‹¤íŒ¨:', err);
            });
        }
        
        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì—°ê²° ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            if (connection) connection.close();
            if (peer) peer.destroy();
        });
    </script>
</body>
</html>
